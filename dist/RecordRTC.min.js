/*! RecordRTC 28-07-2013 */
function StereoAudioRecorder(a,b){function c(a,b){for(var c=a.length+b.length,d=new Float32Array(c),e=0,f=0;c>f;)d[f++]=a[e],d[f++]=b[e],e++;return d}function d(a,b){for(var c=new Float32Array(b),d=0,e=a.length,f=0;e>f;f++){var g=a[f];c.set(g,d),d+=g.length}return c}function e(a,b,c){for(var d=c.length,e=0;d>e;e++)a.setUint8(b+e,c.charCodeAt(e))}var f,g,h,i,j,k=[],l=[],m=!1,n=0,o=44100;this.record=function(){m=!0,k.length=l.length=0,n=0},this.stop=function(){m=!1;var a=d(k,n),f=d(l,n),g=c(a,f),h=new ArrayBuffer(44+2*g.length),i=new DataView(h);e(i,0,"RIFF"),i.setUint32(4,44+2*g.length,!0),e(i,8,"WAVE"),e(i,12,"fmt "),i.setUint32(16,16,!0),i.setUint16(20,1,!0),i.setUint16(22,2,!0),i.setUint32(24,o,!0),i.setUint32(28,4*o,!0),i.setUint16(32,4,!0),i.setUint16(34,16,!0),e(i,36,"data"),i.setUint32(40,2*g.length,!0);for(var j=g.length,p=44,q=1,r=0;j>r;r++)i.setInt16(p,g[r]*32767*q,!0),p+=2;var s=new Blob([i],{type:"audio/wav"});b.ondataavailable(s)},i=window.AudioContext||window.webkitAudioContext,j=new i,g=j.createGain(),h=j.createMediaStreamSource(a),h.connect(g);var p=2048;f=j.createJavaScriptNode(p,2,2),f.onaudioprocess=function(a){if(m){var b=a.inputBuffer.getChannelData(0),c=a.inputBuffer.getChannelData(1);k.push(new Float32Array(b)),l.push(new Float32Array(c)),n+=p}},g.connect(f),f.connect(j.destination)}window.Whammy=function(){function a(a,c){for(var d=b(a),e=3e4,g=[{id:440786851,data:[{data:1,id:17030},{data:1,id:17143},{data:4,id:17138},{data:8,id:17139},{data:"webm",id:17026},{data:2,id:17031},{data:2,id:17029}]},{id:408125543,data:[{id:357149030,data:[{data:1e6,id:2807729},{data:"whammy",id:19840},{data:"whammy",id:22337},{data:k(d.duration),id:17545}]},{id:374648427,data:[{id:174,data:[{data:1,id:215},{data:1,id:25541},{data:0,id:156},{data:"und",id:2274716},{data:"V_VP8",id:134},{data:"VP8",id:2459272},{data:1,id:131},{id:224,data:[{data:d.width,id:176},{data:d.height,id:186}]}]}]}]}],i=0,j=0;i<a.length;){var l=[],m=0;do l.push(a[i]),m+=a[i].duration,i++;while(i<a.length&&e>m);var n=0,o={id:524531317,data:[{data:j,id:231}].concat(l.map(function(a){var b=h({discardable:0,frame:a.data.slice(4),invisible:0,keyframe:1,lacing:0,trackNum:1,timecode:Math.round(n)});return n+=a.duration,{data:b,id:163}}))};g[1].data.push(o),j+=m}return f(g,c)}function b(a){for(var b=a[0].width,c=a[0].height,d=a[0].duration,e=1;e<a.length;e++){if(a[e].width!=b)throw"Frame "+(e+1)+" has a different width";if(a[e].height!=c)throw"Frame "+(e+1)+" has a different height";if(a[e].duration<0||a[e].duration>32767)throw"Frame "+(e+1)+" has a weird duration (must be between 0 and 32767)";d+=a[e].duration}return{duration:d,width:b,height:c}}function c(a){for(var b=[];a>0;)b.push(255&a),a>>=8;return new Uint8Array(b.reverse())}function d(a){for(var b=new Uint8Array(a.length),c=0;c<a.length;c++)b[c]=a.charCodeAt(c);return b}function e(a){var b=[],c=a.length%8?new Array(9-a.length%8).join("0"):"";a=c+a;for(var d=0;d<a.length;d+=8)b.push(parseInt(a.substr(d,8),2));return new Uint8Array(b)}function f(a,b){for(var h=[],i=0;i<a.length;i++){var j=a[i].data;"object"==typeof j&&(j=f(j,b)),"number"==typeof j&&(j=e(j.toString(2))),"string"==typeof j&&(j=d(j)),j.length;var k=j.size||j.byteLength||j.length,l=Math.ceil(Math.ceil(Math.log(k)/Math.log(2))/8),m=k.toString(2),n=new Array(7*l+7+1-m.length).join("0")+m,o=new Array(l).join("0")+"1"+n;h.push(c(a[i].id)),h.push(e(o)),h.push(j)}if(b){var p=g(h);return new Uint8Array(p)}return new Blob(h,{type:"video/webm"})}function g(a,b){null==b&&(b=[]);for(var c=0;c<a.length;c++)"object"==typeof a[c]?g(a[c],b):b.push(a[c]);return b}function h(a){var b=0;if(a.keyframe&&(b|=128),a.invisible&&(b|=8),a.lacing&&(b|=a.lacing<<1),a.discardable&&(b|=1),a.trackNum>127)throw"TrackNumber > 127 not supported";var c=[128|a.trackNum,a.timecode>>8,255&a.timecode,b].map(function(a){return String.fromCharCode(a)}).join("")+a.frame;return c}function i(a){for(var b=a.RIFF[0].WEBP[0],c=b.indexOf("*"),d=0,e=[];4>d;d++)e[d]=b.charCodeAt(c+3+d);var f,g,h,i,j;return j=e[1]<<8|e[0],f=16383&j,g=j>>14,j=e[3]<<8|e[2],h=16383&j,i=j>>14,{width:f,height:h,data:b,riff:a}}function j(a){for(var b=0,c={};b<a.length;){var d=a.substr(b,4),e=parseInt(a.substr(b+4,4).split("").map(function(a){var b=a.charCodeAt(0).toString(2);return new Array(8-b.length+1).join("0")+b}).join(""),2),f=a.substr(b+4+4,e);b+=8+e,c[d]=c[d]||[],"RIFF"==d||"LIST"==d?c[d].push(j(f)):c[d].push(f)}return c}function k(a){return[].slice.call(new Uint8Array(new Float64Array([a]).buffer),0).map(function(a){return String.fromCharCode(a)}).reverse().join("")}function l(a,b){this.frames=[],this.duration=1e3/a,this.quality=b||.8}return l.prototype.add=function(a,b){if("undefined"!=typeof b&&this.duration)throw"you can't pass a duration if the fps is set";if("undefined"==typeof b&&!this.duration)throw"if you don't have the fps set, you ned to have durations here.";if("canvas"in a&&(a=a.canvas),"toDataURL"in a)a=a.toDataURL("image/webp",this.quality);else if("string"!=typeof a)throw"frame must be a a HTMLCanvasElement, a CanvasRenderingContext2D or a DataURI formatted string";if(!/^data:image\/webp;base64,/gi.test(a))throw"Input must be formatted properly as a base64 encoded DataURI of type image/webp";this.frames.push({image:a,duration:b||this.duration})},l.prototype.compile=function(b){return new a(this.frames.map(function(a){var b=i(j(atob(a.image.slice(23))));return b.duration=a.duration,b}),b)},{Video:l,fromImageArray:function(b,c,d){return a(b.map(function(a){var b=i(j(atob(a.slice(23))));return b.duration=1e3/c,b}),d)},toWebM:a}}(),function(){function a(a){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.options=a,this.videoElem=a.videoElem,this.mediaReady=!1,this.videoBlob=null,this.audioBlob=null,this.stream=null,this.whammy=null,this.lastFrameTime=null,this.lastVideoFrame=null,this.audioRecorder=null,navigator.getUserMedia(this.options.enable||h.enable,this.setMedia.bind(this),this.onError.bind(this))}function b(a){return"[object Function]"===Object.prototype.toString.call(a)}navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var c=window,d=c.webkitRequestAnimationFrame||c.mozRequestAnimationFrame,e=c.webkitCancelAnimationFrame||c.mozCancelAnimationFrame,f=c.URL||c.webkitURL,g=c.webkitMediaStream,h=(c.webkitAudioContext||window.mozAudioContext,{enable:{video:!0,audio:!0},canvas_width:320,canvas_height:240,video_fps:10});a.prototype={constructor:a,setMedia:function(a){this.mediaReady=!0,this.stream=a,this.audioStream=new g(a.getAudioTracks()),this.videoElem.src=f.createObjectURL(a)},drawVideoFrame:function(a){this.lastVideoFrame=d(this.drawVideoFrame.bind(this)),this.lastFrameTime||(this.lastFrameTime=a),a-this.lastFrameTime<90||(this.context.drawImage(this.videoElem,0,0,this.v_width,this.v_height,0,0,this.c_width,this.c_height),this.whammy.add(this.canvas),this.lastFrameTime=a)},startVideo:function(){console.log("started recording video frames"),this.c_width=this.options.canvas_width||h.canvas_width,this.c_height=this.options.canvas_height||h.canvas_height,this.v_width=this.options.video_width||this.videoElem.offsetWidth,this.v_height=this.options.video_height||this.videoElem.offsetHeight,this.canvas.width=this.c_width,this.canvas.height=this.c_height,this.videoElem.width=this.v_width,this.videoElem.height=this.v_height,this.whammy=new Whammy.Video(this.options.video_fps||h.video_fps,.6),this.lastVideoFrame=d(this.drawVideoFrame.bind(this))},stopVideo:function(){console.log("stopped recording video frames"),this.lastVideoFrame&&e(this.lastVideoFrame),this.whammy&&this.onVideoReady(this.whammy.compile())},startAudio:function(){console.log("started recording audio frames");var a=this,b={ondataavailable:a.onAudioReady.bind(a)};this.audioRecorder=new StereoAudioRecorder(this.stream,b),this.audioRecorder.record()},stopAudio:function(){this.audioRecorder&&(console.info("stopped recording audio frames"),this.audioRecorder.stop())},start:function(){if(!this.videoElem)throw"No Video Element Found!";if(!this.mediaReady)throw"Media is not ready!";this.options.enable?this.options.enable.video&&this.startVideo():h.enable&&h.enable.video&&this.startVideo(),this.options.enable?this.options.enable.audio&&this.startAudio():h.enable&&h.enable.audio&&this.startAudio()},stop:function(){this.options.enable?this.options.enable.video&&this.stopVideo():h.enable&&h.enable.video&&this.stopVideo(),this.options.enable?this.options.enable.audio&&this.stopAudio():h.enable&&h.enable.audio&&this.stopAudio()},onVideoReady:function(a){console.log("on video ready"),b(a)?(this.onVideoCallback=a,this.videoBlob&&a(this.videoBlob)):(this.videoBlob=a,this.onVideoCallback&&this.onVideoCallback(a))},onAudioReady:function(a){console.log("on audio ready"),b(a)?(this.onAudioCallback=a,this.audioBlob&&a(this.audioBlob)):(this.audioBlob=a,this.onAudioCallback&&this.onAudioCallback(a))},onError:function(a){this.mediaReady=!1,console.log("Failed due to "+a)}},window.RecordRTC=a}();